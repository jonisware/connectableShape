//requires jquery
function connectableShape(e){function o(){for(c in r)r[c].drawMe()}function u(){var e,t;if(n.type=="domobject"){e=n.x=$(n.relatedobject).position().left-1,t=n.y=$(n.relatedobject).position().top-1;var r=$(n.relatedobject).outerWidth(!0)+2,s=$(n.relatedobject).outerHeight(!0)+2;$(i).attr({x:e,y:t,width:r,height:s}),$(i).css({left:e,top:t,"z-index":$(n.relatedobject).zIndex()-1})}else e=parseFloat(n.x)+parseFloat($(i).attr("cxoff")),t=parseFloat(n.y)+parseFloat($(i).attr("cyoff")),$(i).attr("usecx")==1?$(i).attr({cx:e,cy:t}):$(i).attr({x:e,y:t})}function a(){$(i).find("circle,rect,line").css({fill:n.fillcolour,stroke:n.linecolour})}function f(e,t){var n=document.createElementNS("http://www.w3.org/2000/svg",e);for(var r in t)n.setAttribute(r,t[r]);return n}function l(){return t.setType(n.type)?t.drawMe()?t:!1:!1}var t=this,n=$.extend({svgContainer:null,type:"rectangle",relatedObject:null,roundedness:null,width:100,height:100,x:100,y:100,text:"",linecolour:"#000",fillcolour:"#0FF",dragable:!1,onstartdrag:function(e){},ondrag:function(e){},onenddrag:function(e){},onclick:function(e){}},e),r=[];this.connectors=[];var i=null,s={};this.setSVGContainer=function(e){n.svgContainer=e},this.getSVGContainer=function(){return n.svgContainer},this.setType=function(e){if(!s||!s[e])throw"Invalid shape type '"+e+"'";return n.type=e,t.connectors=s[e].conn,!0},this.getPos=function(){var e=parseFloat($(i).outerWidth(!0));if(e==0||isNaN(e))e=parseFloat($(i).attr("width"));var t=parseFloat($(i).outerHeight(!0));if(t==0||isNaN(t))t=parseFloat($(i).attr("height"));return{left:parseFloat($(i).attr("x")),top:parseFloat($(i).attr("y")),width:e,height:t}},this.drawMe=function(){if(!n.svgContainer||n.svgContainer==null)throw"No SVG container specified";return t.setType(n.type)?(i&&i.connectableShapeType!=n.type&&($(i).remove(),i=null),i==null&&s[n.type]&&s[n.type].create&&(i=s[n.type].create(n),$(n.svgContainer).append(i),typeof n.onclick=="function"&&$(i).on("click",n.onclick)),$(i).find("text").html(n.text),u(),a(),$(window).resize(function(){u(),a(),o()}),n.draggable&&$(i).draggable().bind("dragstop",function(e,t){typeof n.ondragstart=="function"&&n.ondragstart({e:e,u:t})}).bind("drag",function(e,t){e.target.setAttribute("x",t.offset.left),e.target.setAttribute("y",t.offset.top),typeof n.ondrag=="function"&&n.ondrag({e:e,u:t}),o()}).bind("dragstop",function(e,t){o(),typeof n.ondragend=="function"&&n.ondragend({e:e,u:t})}),!0):!1},this.joinTo=function(e){var n=$.extend({shapefrom:t},e),r=new connectableJoin(n);return r},this.setActiveConnection=function(e){r.push(e)},s.circle={create:function(e){var t=f("svg",{width:e.width,height:e.height,cxoff:0-e.width/2,cyoff:0-e.height/2,connectableShapeType:"circle"}),n=f("g",{transform:"translate("+e.width/2+","+e.height/2+")"}),r=f("circle",{x:"50%",y:"50%",r:"49%",connectableShapeType:"circle",usecx:1});$(n).append(r);var i=f("text",{x:"0",y:"0","text-anchor":"middle","dominant-baseline":"middle"});return $(n).append(i),$(t).append(n),t},conn:[{x:50,y:0,nx:0,ny:-1},{x:100,y:50,nx:1,ny:0},{x:50,y:100,nx:0,ny:1},{x:0,y:50,nx:-1,ny:0}]},s.rectangle={create:function(e){var t=f("svg",{width:e.width,height:e.height,cxoff:0-e.width/2,cyoff:0-e.height/2,connectableShapeType:"rectangle"}),n=f("g",{}),r=f("rect",{x:0,y:0,width:"100%",height:"100%",cxoff:-50,cyoff:-50,connectableShapeType:"rectangle"});$(n).append(r);var i=f("text",{x:"50%",y:"50%","text-anchor":"middle","dominant-baseline":"middle"});return $(n).append(i),$(t).append(n),t},conn:[{x:50,y:0,nx:0,ny:-1},{x:100,y:50,nx:1,ny:0},{x:50,y:100,nx:0,ny:1},{x:0,y:50,nx:-1,ny:0}]},s.roundedrectangle={create:function(e){var t=parseFloat(n.roundness);isNaN(t)&&(t=10);var r=f("svg",{width:e.width,height:e.height,cxoff:0-e.width/2,cyoff:0-e.height/2,connectableShapeType:"roundedrectangle"}),i=f("g",{}),s=f("rect",{x:0,y:0,width:"100%",height:"100%",cxoff:-50,cyoff:-50,rx:t,ry:t,connectableShapeType:"roundedrectangle"});$(i).append(s);var o=f("text",{x:"50%",y:"50%","text-anchor":"middle","dominant-baseline":"middle"});return $(i).append(o),$(r).append(i),r},conn:[{x:50,y:0,nx:0,ny:-1},{x:100,y:50,nx:1,ny:0},{x:50,y:100,nx:0,ny:1},{x:0,y:50,nx:-1,ny:0}]},s.domobject={create:function(e){var t=e.relatedobject,r=parseFloat(n.roundness);isNaN(r)&&(r=0);var i=f("svg",{width:$(t).width()+2,height:$(t).height()+2,cxoff:($(t).width()+2)/2,cyoff:($(t).height()+2)/2,connectableShapeType:"domobject"}),s=f("g",{width:"100%",height:"100%",preserveAspectRatio:"none"}),o=f("rect",{x:0,y:0,width:"100%",height:"100%",cxoff:"50%",cyoff:"50%",rx:r,ry:r,connectableShapeType:"domobj"});$(s).append(o);var u=f("text",{x:"50%",y:"50%","text-anchor":"middle","dominant-baseline":"middle"});return $(s).append(u),$(i).append(s),i},conn:[{x:50,y:0,nx:0,ny:-1},{x:100,y:50,nx:1,ny:0},{x:50,y:100,nx:0,ny:1},{x:0,y:50,nx:-1,ny:0}]},l()}function connectableJoin(e){function s(){if(n.shapefrom==null||!n.shapefrom.connectors)throw"Missing shape from";if(n.shapeto==null||!n.shapeto.connectors)throw"Missing shape to";n.socketfrom==null?n.socketfrom=0:n.socketfrom=parseInt(n.socketfrom),n.socketto==null?n.socketto=0:n.socketto=parseInt(n.socketto);if(!n.shapefrom.connectors[n.socketfrom]||typeof n.shapefrom.connectors[n.socketfrom].x=="undefined")throw"Missing shape from socket number "+n.socketfrom;if(!n.shapeto.connectors[n.socketto]||typeof n.shapeto.connectors[n.socketto].x=="undefined")throw"Missing shape to socket number "+n.socketto;return!0}function o(){$(r).find("path").css({stroke:n.linecolour})}function u(e,t){var n=document.createElementNS("http://www.w3.org/2000/svg",e);for(var r in t)n.setAttribute(r,t[r]);return n}function a(){if(!s())return!1;n.svgContainer==null&&(n.svgContainer=n.shapefrom.getSVGContainer()),n.shapefrom.setActiveConnection(t),n.shapeto.setActiveConnection(t);if(!$("#csmarkerarrowhead")||!$("#csmarkerarrowhead")[0]){var e=u("defs",{}),r=u("marker",{id:"csmarkerarrowheadstart",markerWidth:"10",markerHeight:"10",refX:"0",refY:"5",orient:"auto"}),o=u("path",{d:"M10,10 L10,0 L0,5 L10,10",stroke:n.linecolour,fill:n.linecolour});$(r).append(o),$(e).append(r);var r=u("marker",{id:"csmarkerarrowheadend",markerWidth:"10",markerHeight:"10",refX:"10",refY:"5",orient:"auto"}),o=u("path",{d:"M0,0 L0,10 L10,5 L0,0",stroke:n.linecolour,fill:n.linecolour});$(r).append(o),$(e).append(r),r=u("marker",{id:"csmarkercrowsfootstart",markerWidth:"10",markerHeight:"10",refX:"0",refY:"5",orient:"auto"}),o=u("path",{d:"M0,0 L10,5 L0,10",stroke:n.linecolour,fill:"none"}),$(r).append(o),$(e).append(r),r=u("marker",{id:"csmarkercrowsfootend",markerWidth:"10",markerHeight:"10",refX:"10",refY:"5",orient:"auto"}),o=u("path",{d:"M10,0 L0,5 L10,10",stroke:n.linecolour,fill:"none"}),$(r).append(o),$(e).append(r),$(n.svgContainer).prepend(e)}i=10,$(n.svgContainer).children().each(function(){i=Math.min(parseInt($(this).zIndex()),i)}),t.drawMe()}var t=this,n=$.extend({svgContainer:null,shapefrom:null,socketfrom:0,shapeto:null,socketto:0,fromend:"none",toend:"none",type:connectableJoin.TypeEnum.STRAIGHT,linecolour:"#000",linewidth:1,onclick:function(e){}},e),r=null,i=10;this.drawMe=function(){if(!s())return!1;var e=n.shapefrom.connectors[n.socketfrom],t=n.shapeto.connectors[n.socketto],o=n.shapefrom.getPos(),a=n.shapeto.getPos(),f=e.x/100*o.width,l=e.y/100*o.height,c=t.x/100*a.width,h=t.y/100*a.height,p="M "+(o.left+f)+" "+(o.top+l);n.type==connectableJoin.TypeEnum.STRAIGHT&&(p+=" L "+(a.left+c)+" "+(a.top+h));if(n.type==connectableJoin.TypeEnum.BEZIER){var d=Math.max(Math.abs(o.left-a.left)/2,75*n.linewidth),v=Math.max(Math.abs(o.top-a.top)/2,75*n.linewidth);p+=" C "+(o.left+f+d*e.nx)+" "+(o.top+l+v*e.ny)+"  "+(a.left+c+d*t.nx)+" "+(a.top+h+v*t.ny)+"  "+(a.left+c)+" "+(a.top+h)}var m=u("svg",{width:"100%",height:"100%",style:"z-index:"+i}),g=u("g",{}),y={d:p,stroke:n.linecolour,"stroke-width":n.linewidth,fill:"none",style:""};n.fromend=="arrow"&&(y.style+="marker-start:url(#csmarkerarrowheadstart);"),n.toend=="arrow"&&(y.style+="marker-end:url(#csmarkerarrowheadend);"),n.fromend=="many"&&(y.style+="marker-start:url(#csmarkercrowsfootstart);"),n.toend=="many"&&(y.style+="marker-end:url(#csmarkercrowsfootend);");var b=u("path",y);$(g).append(b),$(m).append(g),$(r).remove(),r=m,$(n.svgContainer).prepend(r)},a()}connectableJoin.TypeEnum={STRAIGHT:"straight",STRAIGHTLINE:"straight",LINE:"straight",BEZIER:"bezier"};